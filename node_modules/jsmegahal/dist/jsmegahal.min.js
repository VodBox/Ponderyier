(function(){var a,b,c,d=[].slice,e=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};a=function(){function a(a){this.tokens=a,this.canStart=!1,this.canEnd=!1}return a.prototype.hash=function(){return this.tokens.join(",")},a}(),c=function(){function b(a,b){this.markov=null!=a?a:4,this.defaultReply=null!=b?b:"",this.words=Object.create(null),this.quads={},this.next={},this.prev={}}return b.prototype.wordRegex=/[^a-zA-Z0-9,'\u00C0-\u017F]+/,b.prototype.sentenceRegex=/[!?\.]/,b.prototype.randomInt=function(a,b){return Math.floor(Math.random()*(b-a+1)+a)},b.prototype.addQuad=function(a){return a.hash()in this.quads?void 0:this.quads[a.hash()]=a},b.prototype.addMass=function(a){var b=this;return a.split(this.sentenceRegex).forEach(function(a){return b.add(a)})},b.prototype.add=function(b){var c,f,g,h,i,j,k,l,m,n,o,p,q;if(b=b.trim(),!(b.split(" ").length<this.markov)){for(g=b.split(this.wordRegex).filter(Boolean),h=g.length,q=[],c=l=0,o=h-(this.markov-1);o>l;c=l+=1){for(j=new a(d.call(g.slice(c,c+this.markov))),this.addQuad(j),j.canStart=0===c,j.canEnd=c===h-this.markov,p=j.tokens,m=0,n=p.length;n>m;m++)k=p[m],k in this.words||(this.words[k]=[]),this.words[k].push(j);0!==c&&(i=g[c-1],j.hash()in this.prev||(this.prev[j.hash()]=[]),e.call(this.prev[j.hash()],i)>=0||this.prev[j.hash()].push(i)),c<h-this.markov?(f=g[c+this.markov],j.hash()in this.next||(this.next[j.hash()]=[]),e.call(this.next[j.hash()],f)>=0?q.push(void 0):q.push(this.next[j.hash()].push(f))):q.push(void 0)}return q}},b.prototype.getReplyFromSentence=function(a){var b;return b=a.trim().split(" "),this.getReply(b[this.randomInt(0,b.length-1)])},b.prototype.getReply=function(b){var c,e,f,g,h,i,j,k,l,m;if(b=null!=b?b.trim():void 0,m=[],m=b&&b in this.words?this.words[b]:Object.keys(this.quads),0===m.length)return this.defaultReply;for(l=m[this.randomInt(0,m.length-1)],"string"!=typeof l&&(l=l.tokens.join(",")),k=c=this.quads[l],h=k.tokens.slice(0);!k.canEnd&&(g=this.next[k.hash()]);)f=g[this.randomInt(0,g.length-1)],e=new a(d.call(k.tokens.slice(1,this.markov)).concat([f])),this.addQuad(e),k=this.quads[e.hash()],h.push(f);for(k=c;!k.canStart&&(j=this.prev[k.hash()]);)i=j[this.randomInt(0,j.length-1)],e=new a([i].concat(d.call(k.tokens.slice(0,this.markov-1)))),this.addQuad(e),k=this.quads[e.hash()],h.unshift(i);return h.join(" ")},b}(),module.exports=b=c}).call(this);